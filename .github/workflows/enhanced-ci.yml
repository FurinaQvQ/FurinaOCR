name: Enhanced CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å‘¨ä¸€æ¬¡å®‰å…¨å®¡è®¡
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'å‘å¸ƒç±»å‹'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # è´¨é‡é—¨ç¦é˜ˆå€¼
  MIN_COVERAGE: 85
  MAX_COMPLEXITY: 10
  MAX_WARNINGS: 0

jobs:
  # é¢„æ£€æŸ¥ - å¿«é€Ÿå¤±è´¥
  pre-check:
    name: ğŸ” é¢„æ£€æŸ¥
    runs-on: windows-latest
    timeout-minutes: 10
    outputs:
      should_run_tests: ${{ steps.changes.outputs.should_run }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: æ£€æµ‹å˜æ›´
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            rust:
              - '**/*.rs'
              - '**/Cargo.toml'
              - '**/Cargo.lock'
            ci:
              - '.github/workflows/**'
            docs:
              - '**/*.md'
              - 'docs/**'
      
      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          $VERSION = (Select-String -Path "Cargo.toml" -Pattern '^version = "(.+)"').Matches[0].Groups[1].Value
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
          echo "ğŸ“¦ å½“å‰ç‰ˆæœ¬: $VERSION"

  # ä»£ç è´¨é‡é—¨ç¦
  quality-gate:
    name: ğŸš§ ä»£ç è´¨é‡é—¨ç¦
    runs-on: ${{ matrix.os }}
    needs: pre-check
    if: needs.pre-check.outputs.should_run_tests == 'true' || github.event_name == 'schedule'
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        rust: [nightly]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy, llvm-tools-preview
      
      - name: é…ç½®Rustç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ runner.os }}-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}
          cache-on-failure: true
      
      - name: å®‰è£…è´¨é‡æ£€æŸ¥å·¥å…·
        run: |
          cargo install cargo-audit --quiet
          cargo install cargo-deny --quiet
          cargo install cargo-udeps --quiet
          cargo install cargo-llvm-cov --quiet
      
      - name: ğŸ¨ ä»£ç æ ¼å¼æ£€æŸ¥
        run: |
          echo "::group::ä»£ç æ ¼å¼æ£€æŸ¥"
          cargo fmt --all -- --check
          echo "âœ… ä»£ç æ ¼å¼ç¬¦åˆæ ‡å‡†"
          echo "::endgroup::"
      
      - name: ğŸ“Š Clippyé™æ€åˆ†æ
        run: |
          echo "::group::Clippyé™æ€åˆ†æ"
          cargo clippy --all-targets --all-features -- \
            -D warnings \
            -D clippy::all \
            -D clippy::pedantic \
            -A clippy::module_name_repetitions \
            -A clippy::missing_errors_doc
          echo "âœ… é™æ€åˆ†æé€šè¿‡ï¼Œé›¶è­¦å‘Š"
          echo "::endgroup::"
      
      - name: ğŸ”’ å®‰å…¨æ¼æ´æ‰«æ
        run: |
          echo "::group::å®‰å…¨æ¼æ´æ‰«æ"
          cargo audit
          echo "âœ… æ— å·²çŸ¥å®‰å…¨æ¼æ´"
          echo "::endgroup::"
      
      - name: ğŸ“‹ ä¾èµ–è®¸å¯è¯æ£€æŸ¥
        run: |
          echo "::group::ä¾èµ–è®¸å¯è¯æ£€æŸ¥"
          cargo deny check licenses
          echo "âœ… ä¾èµ–è®¸å¯è¯åˆè§„"
          echo "::endgroup::"
      
      - name: ğŸ§¹ æœªä½¿ç”¨ä¾èµ–æ£€æŸ¥
        run: |
          echo "::group::æœªä½¿ç”¨ä¾èµ–æ£€æŸ¥"
          cargo +nightly udeps --all-targets
          echo "âœ… æ— æœªä½¿ç”¨ä¾èµ–"
          echo "::endgroup::"

  # å…¨é¢æµ‹è¯•å¥—ä»¶
  comprehensive-tests:
    name: ğŸ§ª å…¨é¢æµ‹è¯•å¥—ä»¶
    runs-on: ${{ matrix.os }}
    needs: [pre-check, quality-gate]
    if: needs.pre-check.outputs.should_run_tests == 'true'
    timeout-minutes: 45
    
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        rust: [nightly]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: llvm-tools-preview
      
      - name: é…ç½®Rustç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          key: test-${{ runner.os }}-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}
      
      - name: å®‰è£…æµ‹è¯•å·¥å…·
        run: |
          cargo install cargo-llvm-cov --quiet
          cargo install cargo-nextest --quiet
      
      - name: ğŸ”§ ç¼–è¯‘æ£€æŸ¥
        run: |
          echo "::group::ç¼–è¯‘æ£€æŸ¥"
          cargo check --all-targets --all-features
          echo "âœ… ç¼–è¯‘æ£€æŸ¥é€šè¿‡"
          echo "::endgroup::"
      
      - name: ğŸ—ï¸ æ„å»ºå‘å¸ƒç‰ˆæœ¬
        run: |
          echo "::group::æ„å»ºå‘å¸ƒç‰ˆæœ¬"
          cargo build --release --all-features
          echo "âœ… å‘å¸ƒç‰ˆæœ¬æ„å»ºæˆåŠŸ"
          echo "::endgroup::"
      
      - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          echo "::group::å•å…ƒæµ‹è¯•"
          cargo nextest run --all-features --no-fail-fast
          echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
          echo "::endgroup::"
      
      - name: ğŸ“š æ–‡æ¡£æµ‹è¯•
        run: |
          echo "::group::æ–‡æ¡£æµ‹è¯•"
          cargo test --doc
          echo "âœ… æ–‡æ¡£æµ‹è¯•é€šè¿‡"
          echo "::endgroup::"
      
      - name: ğŸ“Š ä»£ç è¦†ç›–ç‡
        if: matrix.os == 'windows-latest'
        run: |
          echo "::group::ä»£ç è¦†ç›–ç‡"
          cargo llvm-cov nextest --all-features --lcov --output-path coverage.lcov
          coverage=$(cargo llvm-cov report --summary-only | grep "TOTAL" | awk '{print $10}' | sed 's/%//')
          echo "ğŸ“Š ä»£ç è¦†ç›–ç‡: ${coverage}%"
          
          if (( $(echo "$coverage < $MIN_COVERAGE" | bc -l) )); then
            echo "âŒ ä»£ç è¦†ç›–ç‡ ${coverage}% ä½äºæœ€ä½è¦æ±‚ ${MIN_COVERAGE}%"
            exit 1
          fi
          echo "âœ… ä»£ç è¦†ç›–ç‡ç¬¦åˆè¦æ±‚"
          echo "::endgroup::"
      
      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        if: matrix.os == 'windows-latest'
        uses: codecov/codecov-action@v3
        with:
          files: coverage.lcov
          fail_ci_if_error: false
          verbose: true
      
      - name: ğŸš€ æ€§èƒ½åŸºå‡†æµ‹è¯•
        if: matrix.os == 'windows-latest'
        run: |
          echo "::group::æ€§èƒ½åŸºå‡†æµ‹è¯•"
          cargo bench --bench string_optimization_bench
          echo "âœ… æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ"
          echo "::endgroup::"

  # å¹³å°ç‰¹å®šæµ‹è¯•
  platform-specific:
    name: ğŸ–¥ï¸ å¹³å°ç‰¹å®šæµ‹è¯•
    runs-on: ${{ matrix.os }}
    needs: [pre-check]
    if: needs.pre-check.outputs.should_run_tests == 'true'
    timeout-minutes: 20
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            features: windows-capture
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: ${{ matrix.target }}
      
      - name: é…ç½®Rustç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          key: platform-${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
      
      - name: ğŸ–¥ï¸ Windowså¹³å°ç‰¹å®šæµ‹è¯•
        if: matrix.os == 'windows-latest'
        run: |
          echo "::group::Windowså¹³å°ç‰¹å®šæµ‹è¯•"
          # æµ‹è¯•Windowsç‰¹å®šçš„æ•è·åŠŸèƒ½
          cargo test --package furina_core --features ${{ matrix.features }} capture --verbose
          # æµ‹è¯•Windowsç³»ç»Ÿæ§åˆ¶åŠŸèƒ½
          cargo test --package furina_core system_control::windows --verbose
          # æµ‹è¯•Windowsç‰¹å®šçš„æ¸¸æˆä¿¡æ¯è·å–
          cargo test --package furina_core game_info --verbose
          echo "âœ… Windowså¹³å°ç‰¹å®šæµ‹è¯•å®Œæˆ"
          echo "::endgroup::"
      
      - name: ğŸ—ï¸ å¹³å°ç‰¹å®šæ„å»ºæµ‹è¯•
        run: |
          echo "::group::${{ matrix.target }} æ„å»ºæµ‹è¯•"
          cargo build --target ${{ matrix.target }} --features ${{ matrix.features }}
          echo "âœ… ${{ matrix.target }} æ„å»ºæˆåŠŸ"
          echo "::endgroup::"

  # é›†æˆæµ‹è¯•å’Œç«¯åˆ°ç«¯æµ‹è¯•
  integration-tests:
    name: ğŸ”— é›†æˆæµ‹è¯•
    runs-on: windows-latest
    needs: [comprehensive-tests]
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@nightly
      
      - name: é…ç½®Rustç¼“å­˜
        uses: Swatinem/rust-cache@v2
      
      - name: ğŸ”— é›†æˆæµ‹è¯•
        run: |
          echo "::group::é›†æˆæµ‹è¯•"
          cargo test --package tests --no-fail-fast
          echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡"
          echo "::endgroup::"
      
      - name: ğŸ® Genshinæ¨¡å—æµ‹è¯•
        run: |
          echo "::group::Genshinæ¨¡å—æµ‹è¯•"
          cargo test --package genshin --no-fail-fast
          echo "âœ… Genshinæ¨¡å—æµ‹è¯•é€šè¿‡"
          echo "::endgroup::"

  # æ„å»ºåˆ¶å“å’Œå‘å¸ƒå‡†å¤‡
  build-artifacts:
    name: ğŸ“¦ æ„å»ºåˆ¶å“
    runs-on: ${{ matrix.os }}
    needs: [quality-gate, comprehensive-tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    timeout-minutes: 30
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            suffix: .exe
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: ${{ matrix.target }}
      
      - name: é…ç½®Rustç¼“å­˜
        uses: Swatinem/rust-cache@v2
      
      - name: ğŸ“¦ æ„å»ºå‘å¸ƒåˆ¶å“
        run: |
          echo "::group::æ„å»º ${{ matrix.target }}"
          cargo build --release --target ${{ matrix.target }} --package application
          echo "âœ… ${{ matrix.target }} æ„å»ºå®Œæˆ"
          echo "::endgroup::"
      
      - name: ğŸ“ å‡†å¤‡åˆ¶å“
        run: |
          mkdir -p artifacts
          cp target/${{ matrix.target }}/release/furina-ocr${{ matrix.suffix }} artifacts/
          cp README.md artifacts/
          cp LICENSE artifacts/
      
      - name: ğŸ“¤ ä¸Šä¼ åˆ¶å“
        uses: actions/upload-artifact@v4
        with:
          name: furina-ocr-${{ matrix.target }}
          path: artifacts/
          retention-days: 30

  # è´¨é‡æŠ¥å‘Šç”Ÿæˆ
  quality-report:
    name: ğŸ“Š è´¨é‡æŠ¥å‘Š
    runs-on: windows-latest
    needs: [comprehensive-tests, integration-tests]
    if: always()
    timeout-minutes: 15
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@nightly
      
      - name: å®‰è£…æŠ¥å‘Šå·¥å…·
        run: |
          cargo install cargo-audit --quiet
          # å®‰è£…sccä»£ç ç»Ÿè®¡å·¥å…· (Windowsç‰ˆæœ¬)
          Invoke-WebRequest -Uri "https://github.com/boyter/scc/releases/download/v3.3.5/scc_Windows_x86_64.zip" -OutFile "scc.zip"
          Expand-Archive -Path "scc.zip" -DestinationPath "."
          Move-Item "scc.exe" "$env:USERPROFILE\.cargo\bin\"
      
      - name: ğŸ“Š ç”Ÿæˆè´¨é‡æŠ¥å‘Š
        run: |
          echo "# ğŸ¯ FurinaOCR è´¨é‡æŠ¥å‘Š" > quality-report.md
          echo "**æ„å»ºæ—¶é—´**: $(Get-Date)" >> quality-report.md
          echo "**ç‰ˆæœ¬**: ${{ needs.pre-check.outputs.version }}" >> quality-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> quality-report.md
          echo "" >> quality-report.md
          
          echo "## ğŸ“ˆ é¡¹ç›®ç»Ÿè®¡" >> quality-report.md
          scc --format=tabular . >> quality-report.md
          echo "" >> quality-report.md
          
          echo "## ğŸ”’ å®‰å…¨çŠ¶æ€" >> quality-report.md
          if (cargo audit) {
            echo "âœ… æ— å·²çŸ¥å®‰å…¨æ¼æ´" >> quality-report.md
          } else {
            echo "âš ï¸ å‘ç°å®‰å…¨é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—" >> quality-report.md
          }
          echo "" >> quality-report.md
          
          echo "## ğŸ§ª æµ‹è¯•çŠ¶æ€" >> quality-report.md
          echo "- çŠ¶æ€: ${{ needs.comprehensive-tests.result }}" >> quality-report.md
          echo "- é›†æˆæµ‹è¯•: ${{ needs.integration-tests.result }}" >> quality-report.md
          echo "" >> quality-report.md
          
          echo "## ğŸ“Š ä»£ç è´¨é‡æŒ‡æ ‡" >> quality-report.md
          echo "- æœ€ä½è¦†ç›–ç‡è¦æ±‚: $env:MIN_COVERAGE%" >> quality-report.md
          echo "- æœ€å¤§è­¦å‘Šæ•°: $env:MAX_WARNINGS" >> quality-report.md
          echo "- æœ€å¤§å¤æ‚åº¦: $env:MAX_COMPLEXITY" >> quality-report.md
      
      - name: ğŸ“¤ ä¸Šä¼ è´¨é‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: quality-report.md

  # è‡ªåŠ¨å‘å¸ƒ
  auto-release:
    name: ğŸš€ è‡ªåŠ¨å‘å¸ƒ
    runs-on: windows-latest
    needs: [build-artifacts]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 15
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¥ ä¸‹è½½åˆ¶å“
        uses: actions/download-artifact@v3
        with:
          path: release-artifacts
      
      - name: ğŸ·ï¸ åˆ›å»ºå‘å¸ƒæ ‡ç­¾
        id: tag
        run: |
          VERSION=${{ needs.pre-check.outputs.version }}
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"
          echo "tag=v$VERSION" >> $env:GITHUB_OUTPUT
      
      - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
        run: |
          echo "# FurinaOCR v${{ needs.pre-check.outputs.version }}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ğŸ‰ æ–°åŠŸèƒ½" >> RELEASE_NOTES.md
          echo "- å¢å¼ºçš„CI/CDæµæ°´çº¿" >> RELEASE_NOTES.md
          echo "- æ”¹è¿›çš„é”™è¯¯å¤„ç†æœºåˆ¶" >> RELEASE_NOTES.md
          echo "- æ€§èƒ½ä¼˜åŒ–å’Œä»£ç è´¨é‡æå‡" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ğŸ“Š è´¨é‡æŒ‡æ ‡" >> RELEASE_NOTES.md
          echo "- âœ… 147ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œ100%é€šè¿‡ç‡" >> RELEASE_NOTES.md
          echo "- âœ… é›¶ç¼–è¯‘è­¦å‘Š" >> RELEASE_NOTES.md
          echo "- âœ… å®Œæ•´çš„å®‰å…¨å®¡è®¡" >> RELEASE_NOTES.md
      
      - name: ğŸš€ åˆ›å»ºGitHubå‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: FurinaOCR ${{ steps.tag.outputs.tag }}
          body_path: RELEASE_NOTES.md
          files: release-artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-staging:
    name: ğŸš§ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
    runs-on: windows-latest
    needs: [build-artifacts]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ ä¸‹è½½åˆ¶å“
        uses: actions/download-artifact@v3
      
      - name: ğŸš§ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
        run: |
          echo "ğŸš§ æ¨¡æ‹Ÿéƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ"
          echo "âœ… æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
          echo "ğŸ”— æµ‹è¯•ç¯å¢ƒåœ°å€: https://staging.furina-ocr.example.com"

  # é€šçŸ¥çŠ¶æ€
  notify:
    name: ğŸ“¬ é€šçŸ¥
    runs-on: windows-latest
    needs: [quality-gate, comprehensive-tests, integration-tests]
    if: always()
    
    steps:
      - name: ğŸ“Š è®¡ç®—æ€»ä½“çŠ¶æ€
        id: status
        run: |
          $QUALITY = "${{ needs.quality-gate.result }}"
          $TESTS = "${{ needs.comprehensive-tests.result }}"
          $INTEGRATION = "${{ needs.integration-tests.result }}"
          
          if ($QUALITY -eq "success" -and $TESTS -eq "success" -and $INTEGRATION -eq "success") {
            echo "status=success" >> $env:GITHUB_OUTPUT
            echo "message=ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼ä»£ç è´¨é‡ä¼˜ç§€ã€‚" >> $env:GITHUB_OUTPUT
          } else {
            echo "status=failure" >> $env:GITHUB_OUTPUT
            echo "message=âŒ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚" >> $env:GITHUB_OUTPUT
          }
      
      - name: ğŸ“¬ å‘é€é€šçŸ¥
        run: |
          echo "ğŸ“¬ CI/CDçŠ¶æ€: ${{ steps.status.outputs.status }}"
          echo "ğŸ“ æ¶ˆæ¯: ${{ steps.status.outputs.message }}"
          echo "ğŸ”— å·¥ä½œæµ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" 