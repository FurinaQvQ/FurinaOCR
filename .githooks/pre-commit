#!/bin/bash
# FurinaOCR Git Pre-commit Hook
# ç¡®ä¿æäº¤å‰ä»£ç è´¨é‡ç¬¦åˆæ ‡å‡†

set -e

# é¢œè‰²è¾“å‡ºå‡½æ•°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

success() { echo -e "${GREEN}âœ… $1${NC}"; }
warning() { echo -e "${YELLOW}âš ï¸ $1${NC}"; }
error() { echo -e "${RED}âŒ $1${NC}"; }
info() { echo -e "${BLUE}â„¹ï¸ $1${NC}"; }
header() { echo -e "\n${BLUE}ğŸ¯ $1${NC}"; }

# æ£€æŸ¥æ˜¯å¦åœ¨Gitä»“åº“ä¸­
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    error "ä¸åœ¨Gitä»“åº“ä¸­"
    exit 1
fi

header "FurinaOCR é¢„æäº¤è´¨é‡æ£€æŸ¥"

# æ£€æŸ¥æ˜¯å¦æœ‰å¾…æäº¤çš„Rustæ–‡ä»¶
rust_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(rs|toml)$' || true)

if [ -z "$rust_files" ]; then
    info "æ²¡æœ‰Rustæ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æ£€æŸ¥"
    exit 0
fi

info "æ£€æµ‹åˆ°ä»¥ä¸‹Rustæ–‡ä»¶å˜æ›´:"
echo "$rust_files" | sed 's/^/  - /'

# æ£€æŸ¥Rustå·¥å…·é“¾
header "æ£€æŸ¥Rustå·¥å…·é“¾"
if ! command -v cargo &> /dev/null; then
    error "Cargoæœªå®‰è£…æˆ–ä¸åœ¨PATHä¸­"
    exit 1
fi

if ! command -v rustfmt &> /dev/null; then
    error "rustfmtæœªå®‰è£…ï¼Œè¿è¡Œ: rustup component add rustfmt"
    exit 1
fi

if ! command -v cargo-clippy &> /dev/null; then
    error "clippyæœªå®‰è£…ï¼Œè¿è¡Œ: rustup component add clippy"
    exit 1
fi

success "Rustå·¥å…·é“¾æ£€æŸ¥é€šè¿‡"

# ä»£ç æ ¼å¼æ£€æŸ¥
header "ä»£ç æ ¼å¼æ£€æŸ¥"
if ! cargo fmt --all -- --check > /dev/null 2>&1; then
    error "ä»£ç æ ¼å¼ä¸ç¬¦åˆæ ‡å‡†"
    info "è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¿®å¤æ ¼å¼é—®é¢˜:"
    echo "  cargo fmt --all"
    exit 1
fi
success "ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"

# Clippyé™æ€åˆ†æï¼ˆä»…æ£€æŸ¥å˜æ›´æ–‡ä»¶ç›¸å…³çš„è­¦å‘Šï¼‰
header "Clippyé™æ€åˆ†æ"
if ! cargo clippy --all-targets -- -D warnings > /dev/null 2>&1; then
    error "Clippyæ£€æŸ¥å‘ç°é—®é¢˜"
    info "è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯:"
    echo "  cargo clippy --all-targets -- -D warnings"
    exit 1
fi
success "Clippyæ£€æŸ¥é€šè¿‡ï¼Œé›¶è­¦å‘Š"

# å¿«é€Ÿç¼–è¯‘æ£€æŸ¥
header "ç¼–è¯‘æ£€æŸ¥"
if ! cargo check --all-targets > /dev/null 2>&1; then
    error "ç¼–è¯‘æ£€æŸ¥å¤±è´¥"
    info "è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹è¯¦ç»†é”™è¯¯:"
    echo "  cargo check --all-targets"
    exit 1
fi
success "ç¼–è¯‘æ£€æŸ¥é€šè¿‡"

# è¿è¡Œæµ‹è¯•ï¼ˆä»…æ ¸å¿ƒæµ‹è¯•ï¼‰
header "æ ¸å¿ƒæµ‹è¯•"
if ! cargo test --lib > /dev/null 2>&1; then
    error "æ ¸å¿ƒæµ‹è¯•å¤±è´¥"
    info "è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯:"
    echo "  cargo test --lib"
    exit 1
fi
success "æ ¸å¿ƒæµ‹è¯•é€šè¿‡"

# æ£€æŸ¥TODOå’ŒFIXMEæ³¨é‡Š
header "æ£€æŸ¥å¾…åŠäº‹é¡¹"
todo_count=$(git diff --cached | grep -E '^\+.*TODO|^\+.*FIXME' | wc -l || true)
if [ "$todo_count" -gt 0 ]; then
    warning "æ£€æµ‹åˆ° $todo_count ä¸ªæ–°çš„TODO/FIXMEæ³¨é‡Š"
    info "è¯·ç¡®ä¿è¿™äº›æ˜¯æœ‰æ„æ·»åŠ çš„:"
    git diff --cached | grep -E '^\+.*TODO|^\+.*FIXME' | sed 's/^+/  /'
fi

# æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
header "æ•æ„Ÿä¿¡æ¯æ£€æŸ¥"
sensitive_patterns=("password" "secret" "key" "token" "api_key")
found_sensitive=false

for pattern in "${sensitive_patterns[@]}"; do
    if git diff --cached | grep -qi "$pattern"; then
        warning "å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯: $pattern"
        found_sensitive=true
    fi
done

if [ "$found_sensitive" = true ]; then
    error "æ£€æµ‹åˆ°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯ï¼Œè¯·æ£€æŸ¥åå†æäº¤"
    exit 1
fi

# æ£€æŸ¥æäº¤æ¶ˆæ¯é•¿åº¦ï¼ˆå¦‚æœå·²æŒ‡å®šï¼‰
if [ -n "$1" ]; then
    commit_msg_file="$1"
    if [ -f "$commit_msg_file" ]; then
        commit_msg=$(head -n 1 "$commit_msg_file")
        if [ ${#commit_msg} -gt 72 ]; then
            warning "æäº¤æ¶ˆæ¯æ ‡é¢˜è¿‡é•¿ (${#commit_msg} å­—ç¬¦ï¼Œå»ºè®® â‰¤ 72)"
        fi
        
        if ! echo "$commit_msg" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci)(\(.+\))?: .+'; then
            warning "æäº¤æ¶ˆæ¯ä¸ç¬¦åˆçº¦å®šå¼æäº¤æ ¼å¼"
            info "æ¨èæ ¼å¼: type(scope): description"
            info "ä¾‹å¦‚: feat(core): æ·»åŠ æ–°çš„OCRè¯†åˆ«ç®—æ³•"
        fi
    fi
fi

# æœ€ç»ˆæ£€æŸ¥ç»“æœ
header "é¢„æäº¤æ£€æŸ¥å®Œæˆ"
success "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼å¯ä»¥å®‰å…¨æäº¤ã€‚"

# æç¤ºæ€§èƒ½æé†’
info "æç¤º: æäº¤åå°†è§¦å‘å®Œæ•´çš„CI/CDæµæ°´çº¿"
info "å»ºè®®åœ¨æ¨é€å‰è¿è¡Œ: ./scripts/quality-check.ps1 -Full"

exit 0 